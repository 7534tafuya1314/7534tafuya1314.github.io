<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 头部内容保持不变 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>哲理论-探索思维的点滴</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Noto+Sans+SC:wght@700;900&family=Krona+One&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5A2B',
                        secondary: '#D2B48C',
                        accent: '#CD853F',
                        dark: '#3E2723',
                        light: '#F5F5DC'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        <!-- 样式内容保持不变 -->
        @layer utilities {
            .text-shadow {
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            }
            .transition-all-300 {
                transition: all 0.3s ease;
            }
            .editor-toolbar {
                @apply bg-gray-100 p-2 border-b flex flex-wrap gap-2;
            }
            .editor-button {
                @apply p-1.5 rounded hover:bg-gray-200 transition-all-300;
            }
        }
        
        body {
            background-color: #F5F5DC;
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .哲学标题 {
            font-family: 'Krona One', sans-serif;
        }
        
        .hero-section {
            background-image: url('https://p11-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/9005186ae3764f5885bf9fb051e353ed.png~tplv-a9rns2rl98-24:720:720.png?rcl=20251004093514250C7EA54B20B9A718B5&rk3s=8e244e95&rrcfp=8a172a1a&x-expires=1760146514&x-signature=%2BhaweaigBWWu8yZUpDV74jGJQtQ%3D');
            background-size: cover;
            background-position: center;
            position: relative;
            height: 96px;
        }
        
        @media (min-width: 768px) {
            .hero-section {
                height: 384px;
            }
        }
        
        .hero-section::before {
            content: '';
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .分类标签 {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background-color: #D2B48C;
            color: #3E2723;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin: 0 8px 8px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .分类标签:hover, .分类标签.active {
            background-color: #8B5A2B;
            color: white;
        }
        
        .文章-card {
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .文章-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 1000px;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {opacity: 0; transform: translateY(-50px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close-btn:hover {
            color: #8B5A2B;
        }
        
        /* 小巧的加载指示器样式 */
        .small-loader {
            border: 3px solid rgba(139, 90, 43, 0.2);
            border-radius: 50%;
            border-top: 3px solid #8B5A2B;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        
        .loader-container {
            text-align: center;
            padding: 20px 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .今日日期标记 {
            border: 2px solid #8B5A2B;
            background-color: rgba(139, 90, 43, 0.1);
        }
        
        .哲言区域 {
            border-top: 1px solid #eee;
            padding-top: 15px;
            margin-top: 15px;
            font-style: italic;
            color: #555;
        }
        
        .admin-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
        }
        
        @media (max-width: 767px) {
            .admin-container {
                grid-template-columns: 1fr;
            }
        }
        
        .admin-sidebar {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
        }
        
        .admin-content {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        
        .admin-menu-item {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .admin-menu-item:hover, .admin-menu-item.active {
            background-color: #e9ecef;
        }
        
        .admin-section {
            display: none;
        }
        
        .admin-section.active {
            display: block;
        }
        
        .markdown-editor {
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        #article-editor {
            width: 100%;
            min-height: 300px;
            border: none;
            padding: 15px;
            resize: vertical;
            font-family: monospace;
        }
        
        #preview-container {
            border-top: 1px solid #ddd;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1001;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .status-message.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .status-success {
            background-color: #4CAF50;
        }
        
        .status-error {
            background-color: #f44336;
        }
        
        .error-log {
            margin-top: 10px;
            padding: 10px;
            background-color: #fff3f3;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #dc2626;
        }
        
        .repo-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .repo-item:hover {
            background-color: #f5f5f5;
            border-color: #8B5A2B;
        }
        
        .repo-item.selected {
            background-color: #f0e6d6;
            border-color: #8B5A2B;
        }
    </style>
</head>
<body>
    <!-- 页面结构保持不变 -->
    <!-- 导航栏 -->
    <nav class="bg-dark text-white p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold 哲学标题">哲理论</h1>
            <div class="flex items-center gap-4">
                <button id="尘幕工作室按钮" class="hover:text-secondary transition-all-300 flex items-center gap-1">
                    <i class="fa fa-cogs" aria-hidden="true"></i>
                    <span class="hidden sm:inline">尘幕工作室</span>
                </button>
                <button id="日历按钮" class="hover:text-secondary transition-all-300">
                    <i class="fa fa-calendar" aria-hidden="true"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- 英雄区域 -->
    <section class="hero-section flex items-center justify-center">
        <div class="container mx-auto px-4 text-center text-white relative z-10">
            <h1 class="text-4xl md:text-6xl font-bold mb-4 text-shadow">探索思维的点滴</h1>
            <p class="text-xl md:text-2xl max-w-2xl mx-auto">记录哲学思考，分享思想火花</p>
        </div>
    </section>

    <!-- 分类区域 -->
    <section class="py-8 bg-light">
        <div class="container mx-auto px-4">
            <div id="分类容器" class="flex flex-wrap mb-8">
                <span class="分类标签 active" data-category="all">全部</span>
                <!-- 分类标签通过JS动态生成 -->
            </div>
        </div>
    </section>

    <!-- 文章列表区域 -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <!-- 加载指示器容器 -->
            <div id="文章加载指示器" class="loader-container">
                <div class="small-loader"></div>
                <p class="text-gray-500 text-sm mt-2">加载文章中...</p>
            </div>
            
            <div id="文章列表" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 hidden">
                <!-- 文章卡片通过JS动态生成 -->
            </div>
        </div>
    </section>

    <!-- 日历模态框 -->
    <div id="日历模态框" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div class="p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                    <div class="mb-3 md:mb-0">
                        <h2 class="text-2xl font-bold">日历</h2>
                        <div id="当前时间显示" class="text-gray-600 mt-1"></div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="上一月" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-l">
                            <i class="fa fa-chevron-left" aria-hidden="true"></i>
                        </button>
                        <span id="当前年月" class="px-4 py-1 bg-gray-100"></span>
                        <button id="下一月" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-r">
                            <i class="fa fa-chevron-right" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
                <div id="日历网格" class="grid grid-cols-7 gap-2 text-center mb-6">
                    <!-- 日历通过JS动态生成 -->
                </div>
                <div id="哲言区域" class="哲言区域 text-center">
                    <!-- 哲言通过JS动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 文章详情模态框 -->
    <div id="文章详情模态框" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <div id="文章详情内容">
                <!-- 文章详情通过JS动态生成 -->
            </div>
        </div>
    </div>

    <!-- 仓库检测失败提示模态框 -->
    <div id="repo-detect-fail-modal" class="modal">
        <div class="modal-content max-w-md">
            <span class="close-btn">&times;</span>
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4 text-red-500">仓库检测失败</h2>
                <p class="mb-4">无法从URL自动检测GitHub仓库信息。请输入GitHub令牌，我们将从您的仓库中查找。</p>
                <div id="repo-detect-error" class="error-log mb-4"></div>
                <button id="go-to-auth-btn" class="w-full bg-primary text-white py-2 px-4 rounded hover:bg-accent transition-all-300">
                    输入GitHub令牌
                </button>
            </div>
        </div>
    </div>

    <!-- 仓库选择模态框 -->
    <div id="repo-select-modal" class="modal">
        <div class="modal-content max-w-2xl">
            <span class="close-btn">&times;</span>
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">选择博客仓库</h2>
                <p class="mb-4 text-gray-600">请选择用于存储博客文章的仓库（推荐使用名称包含"philosophy"或"blog"的仓库）</p>
                
                <div id="repo-loading" class="text-center py-8">
                    <div class="small-loader"></div>
                    <p class="text-gray-500 mt-4">加载您的仓库列表中...</p>
                </div>
                
                <div id="repo-list-container" class="hidden max-h-96 overflow-y-auto pr-2">
                    <div id="repo-list" class="space-y-2">
                        <!-- 仓库列表将通过JS动态生成 -->
                    </div>
                </div>
                
                <div id="repo-select-error" class="error-log mb-4 hidden"></div>
                
                <div class="mt-6 flex justify-end">
                    <button id="confirm-repo-btn" class="bg-primary text-white py-2 px-6 rounded hover:bg-accent transition-all-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        确认选择
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub令牌验证模态框 -->
    <div id="github验证模态框" class="modal">
        <div class="modal-content max-w-md">
            <span class="close-btn">&times;</span>
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">GitHub API 验证</h2>
                <p class="mb-4 text-gray-600">请输入您的GitHub个人访问令牌以访问管理功能</p>
                <div class="mb-4">
                    <label for="github-token" class="block mb-2">个人访问令牌</label>
                    <input type="password" id="github-token" class="w-full p-2 border border-gray-300 rounded" placeholder="ghp_...">
                    <p class="text-xs text-gray-500 mt-1">令牌需要有 repo 权限（创建时勾选repo选项）</p>
                </div>
                <button id="验证按钮" class="w-full bg-primary text-white py-2 px-4 rounded hover:bg-accent transition-all-300">
                    验证并继续
                </button>
                <div id="验证状态" class="mt-3 text-center hidden"></div>
                <div id="验证错误日志" class="error-log"></div>
            </div>
        </div>
    </div>
        <!-- 后台管理模态框 -->
    <div id="后台管理模态框" class="modal">
        <div class="modal-content max-w-5xl">
            <span class="close-btn">&times;</span>
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-6">后台管理</h2>
                <div id="admin-loading" class="text-center py-8">
                    <div class="small-loader"></div>
                    <p class="text-gray-500 mt-4">加载管理界面中...</p>
                </div>
                <div class="admin-container hidden" id="admin-content-container">
                    <div class="admin-sidebar">
                        <div class="admin-menu-item active" data-section="write-article">
                            <i class="fa fa-pencil mr-2"></i>撰写文章
                        </div>
                        <div class="admin-menu-item" data-section="manage-articles">
                            <i class="fa fa-list mr-2"></i>管理文章
                        </div>
                        <div class="admin-menu-item" data-section="manage-categories">
                            <i class="fa fa-tags mr-2"></i>管理分类
                        </div>
                        <div class="admin-menu-item" id="切换仓库按钮">
                            <i class="fa fa-exchange mr-2"></i>切换仓库
                        </div>
                        <div class="admin-menu-item" id="退出登录按钮">
                            <i class="fa fa-sign-out mr-2"></i>退出登录
                        </div>
                        <div class="mt-6 pt-6 border-t">
                            <p class="text-sm text-gray-500">当前仓库: <br><span id="current-repo-info" class="font-medium"></span></p>
                        </div>
                    </div>
                    
                    <div class="admin-content">
                        <!-- 撰写文章区域 -->
                        <div class="admin-section active" id="write-article">
                            <h3 class="text-xl font-bold mb-4">撰写新文章</h3>
                            
                            <div class="mb-4">
                                <label for="article-title" class="block mb-2">文章标题</label>
                                <input type="text" id="article-title" class="w-full p-2 border border-gray-300 rounded" placeholder="输入文章标题">
                            </div>
                            
                            <div class="mb-4">
                                <label class="block mb-2">选择分类 (可多选)</label>
                                <div id="category-selector" class="flex flex-wrap gap-2">
                                    <!-- 分类选项将通过JS动态生成 -->
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block mb-2">文章内容 (Markdown格式)</label>
                                <div class="markdown-editor">
                                    <div class="editor-toolbar">
                                        <button class="editor-button" data-command="bold" title="加粗"><i class="fa fa-bold"></i></button>
                                        <button class="editor-button" data-command="italic" title="斜体"><i class="fa fa-italic"></i></button>
                                        <button class="editor-button" data-command="heading" title="标题"><i class="fa fa-header"></i></button>
                                        <button class="editor-button" data-command="list" title="列表"><i class="fa fa-list-ul"></i></button>
                                        <button class="editor-button" data-command="link" title="链接"><i class="fa fa-link"></i></button>
                                        <button class="editor-button" data-command="image" title="图片"><i class="fa fa-image"></i></button>
                                        <button class="editor-button" data-command="code" title="代码"><i class="fa fa-code"></i></button>
                                    </div>
                                    <textarea id="article-editor" placeholder="请使用Markdown格式编写文章内容...&#10;&#10;注意: 文章第一行用于指定分类ID，用逗号分隔，空行表示无分类"></textarea>
                                    <div id="preview-container">
                                        <p class="text-gray-500 italic">预览将显示在这里...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end">
                                <button id="发布文章按钮" class="bg-primary text-white py-2 px-6 rounded hover:bg-accent transition-all-300">
                                    <i class="fa fa-paper-plane mr-2"></i>发布文章
                                </button>
                            </div>
                        </div>
                        
                        <!-- 管理文章区域 -->
                        <div class="admin-section" id="manage-articles">
                            <h3 class="text-xl font-bold mb-4">管理已发布文章</h3>
                            <div class="overflow-x-auto">
                                <table id="articles-table" class="min-w-full bg-white">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="py-3 px-4 text-left">标题</th>
                                            <th class="py-3 px-4 text-left">发布日期</th>
                                            <th class="py-3 px-4 text-left">分类</th>
                                            <th class="py-3 px-4 text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- 文章数据将通过JS动态生成 -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- 管理分类区域 -->
                        <div class="admin-section" id="manage-categories">
                            <h3 class="text-xl font-bold mb-4">管理分类</h3>
                            
                            <div class="mb-6">
                                <h4 class="font-bold mb-2">添加新分类</h4>
                                <div class="flex gap-2">
                                    <input type="text" id="new-category-name" class="flex-1 p-2 border border-gray-300 rounded" placeholder="分类名称">
                                    <button id="add-category-btn" class="bg-primary text-white py-2 px-4 rounded hover:bg-accent transition-all-300">
                                        添加
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h4 class="font-bold mb-2">现有分类</h4>
                                <div id="categories-list" class="space-y-2">
                                    <!-- 分类列表将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 状态消息提示 -->
    <div id="status-message" class="status-message"></div>

    <script>
        // 配置模块 - 已设置为指定仓库
        const Config = {
            githubAPI: 'https://api.github.com',
            defaultRepoName: '7534tafuya1314.github.io', // 指定仓库名
            articlesDir: 'articles',
            categoriesFile: 'categories.json',
            syncInterval: 30000 // 自动同步间隔30秒
        };

        // 状态管理模块
        const State = {
            articles: [],
            categories: [],
            currentDate: new Date(),
            selectedCategory: 'all',
            githubToken: localStorage.getItem('githubToken') || null,
            githubOwner: '7534tafuya1314', // 固定仓库所有者
            githubRepo: '7534tafuya1314.github.io', // 固定仓库名
            isAuthenticated: !!localStorage.getItem('githubToken'),
            lastSyncTime: null,
            philosophicalQuotes: [
                { quote: "未经审视的人生，是不值得过的。", author: "苏格拉底" },
                { quote: "存在先于本质。", author: "萨特" },
                { quote: "我思故我在。", author: "笛卡尔" },
                { quote: "世界是一团永恒的活火。", author: "赫拉克利特" },
                { quote: "人不能两次踏入同一条河流。", author: "赫拉克利特" },
                { quote: "知之为知之，不知为不知，是知也。", author: "孔子" },
                { quote: "真理是时间的孩子，不是权威的孩子。", author: "伽利略" },
                { quote: "人是万物的尺度。", author: "普罗泰戈拉" },
                { quote: "过去属于死神，未来属于你自己。", author: "雪莱" },
                { quote: "人是生而自由的，但却无往不在枷锁之中。", author: "卢梭" }
            ],
            articleSummaryCache: new Map(),
            selectedRepo: null // 当前选中的仓库
        };

        // DOM元素缓存模块
        const Elements = (() => {
            const get = (id) => document.getElementById(id);
            return {
                // 导航与主要功能
                日历按钮: get('日历按钮'),
                日历模态框: get('日历模态框'),
                文章详情模态框: get('文章详情模态框'),
                分类容器: get('分类容器'),
                文章列表: get('文章列表'),
                文章加载指示器: get('文章加载指示器'),
                上一月按钮: get('上一月'),
                下一月按钮: get('下一月'),
                当前年月显示: get('当前年月'),
                日历网格: get('日历网格'),
                当前时间显示: get('当前时间显示'),
                哲言区域: get('哲言区域'),
                文章详情内容: get('文章详情内容'),
                尘幕工作室按钮: get('尘幕工作室按钮'),
                
                // 仓库检测与选择
                repoDetectFailModal: get('repo-detect-fail-modal'),
                repoDetectError: get('repo-detect-error'),
                goToAuthBtn: get('go-to-auth-btn'),
                repoSelectModal: get('repo-select-modal'),
                repoList: get('repo-list'),
                repoListContainer: get('repo-list-container'),
                repoLoading: get('repo-loading'),
                repoSelectError: get('repo-select-error'),
                confirmRepoBtn: get('confirm-repo-btn'),
                切换仓库按钮: get('切换仓库按钮'),
                
                // GitHub验证
                github验证模态框: get('github验证模态框'),
                githubTokenInput: get('github-token'),
                验证按钮: get('验证按钮'),
                验证状态: get('验证状态'),
                验证错误日志: get('验证错误日志'),
                
                // 后台管理
                后台管理模态框: get('后台管理模态框'),
                退出登录按钮: get('退出登录按钮'),
                adminMenuItems: document.querySelectorAll('.admin-menu-item'),
                adminSections: document.querySelectorAll('.admin-section'),
                发布文章按钮: get('发布文章按钮'),
                articleTitleInput: get('article-title'),
                articleEditor: get('article-editor'),
                previewContainer: get('preview-container'),
                categorySelector: get('category-selector'),
                articlesTable: get('articles-table'),
                newCategoryName: get('new-category-name'),
                addCategoryBtn: get('add-category-btn'),
                categoriesList: get('categories-list'),
                adminLoading: get('admin-loading'),
                adminContentContainer: get('admin-content-container'),
                currentRepoInfo: get('current-repo-info'),
                
                // 通用
                statusMessage: get('status-message'),
                closeButtons: document.querySelectorAll('.close-btn'),
                modals: document.querySelectorAll('.modal'),
                editorButtons: document.querySelectorAll('.editor-button')
            };
        })();

        // 工具函数模块
        const Utils = {
            formatDate(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            },
            
            formatDateTime(date) {
                return `${this.formatDate(date)} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            },
            
            htmlToText(html) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                return tempDiv.textContent || '';
            },
            
            getArticleSummary(content) {
                if (State.articleSummaryCache.has(content)) {
                    return State.articleSummaryCache.get(content);
                }
                
                const plainText = this.htmlToText(content);
                const summary = plainText.length > 100 
                    ? plainText.substring(0, 100) + '...' 
                    : plainText;
                
                State.articleSummaryCache.set(content, summary);
                return summary;
            },
            
            createFragment() {
                return document.createDocumentFragment();
            },
            
            showStatusMessage(message, isError = false) {
                const statusEl = Elements.statusMessage;
                statusEl.textContent = message;
                statusEl.className = 'status-message';
                statusEl.classList.add(isError ? 'status-error' : 'status-success');
                statusEl.classList.add('show');
                
                setTimeout(() => {
                    statusEl.classList.remove('show');
                }, 3000);
            },
            
            encodeBase64(str) {
                return btoa(unescape(encodeURIComponent(str)));
            },
            
            decodeBase64(str) {
                return decodeURIComponent(escape(atob(str)));
            },
            
            generateArticleFileName(title) {
                const date = this.formatDate(new Date());
                const sanitizedTitle = title.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .replace(/\s+/g, '-');
                return `${date}-${sanitizedTitle}.md`;
            },
            
            showErrorLog(element, message) {
                element.textContent = message;
                element.style.display = 'block';
            },
            
            hideErrorLog(element) {
                element.textContent = '';
                element.style.display = 'none';
            },
            
            // 添加时间戳参数防止缓存
            addCacheBuster(url) {
                const separator = url.includes('?') ? '&' : '?';
                return `${url}${separator}t=${new Date().getTime()}`;
            },
            
            // 保存仓库信息到本地存储
            saveRepoInfo(owner, repo) {
                localStorage.setItem('githubOwner', owner);
                localStorage.setItem('githubRepo', repo);
                State.githubOwner = owner;
                State.githubRepo = repo;
            },
            
            // 生成新的分类ID（自然整数）
            generateCategoryId() {
                if (State.categories.length === 0) {
                    return 1;
                }
                // 找到最大的ID并加1
                const maxId = Math.max(...State.categories.map(cat => cat.id));
                return maxId + 1;
            }
        };

        // GitHub API模块 - 修改为支持匿名访问公开仓库
        const GitHubAPI = {
            getHeaders(needAuth = false) {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                };
                
                // 只有需要认证的操作才添加令牌
                if (needAuth && State.githubToken) {
                    headers['Authorization'] = `token ${State.githubToken}`;
                }
                
                return headers;
            },
            
            // 获取用户信息（用于验证令牌）
            async getUserInfo() {
                try {
                    const response = await fetch(`${Config.githubAPI}/user`, {
                        headers: this.getHeaders(true)
                    });
                    
                    if (!response.ok) {
                        const error = await response.text();
                        console.error('获取用户信息失败:', error);
                        return null;
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('获取用户信息时发生错误:', error);
                    return null;
                }
            },
            
            // 获取用户的仓库列表
            async getUserRepos() {
                try {
                    const response = await fetch(`${Config.githubAPI}/user/repos?per_page=100`, {
                        headers: this.getHeaders(true)
                    });
                    
                    if (!response.ok) {
                        const error = await response.text();
                        console.error('获取仓库列表失败:', error);
                        return { success: false, error };
                    }
                    
                    const repos = await response.json();
                    return { success: true, repos };
                } catch (error) {
                    console.error('获取仓库列表时发生错误:', error);
                    return { success: false, error: error.message };
                }
            },
            
            async testToken() {
                const userInfo = await this.getUserInfo();
                return !!userInfo;
            },
            
            // 获取指定路径下的文件列表 - 公开仓库不需要认证
            async getFilesList(path, needAuth = false) {
                try {
                    const response = await fetch(
                        `${Config.githubAPI}/repos/${State.githubOwner}/${State.githubRepo}/contents/${path}`,
                        { headers: this.getHeaders(needAuth) }
                    );
                    
                    if (!response.ok) {
                        // 如果是404错误，可能是目录不存在，可以视为空列表
                        if (response.status === 404) {
                            return { success: true, files: [] };
                        }
                        
                        const error = await response.text();
                        console.error('获取文件列表失败:', error);
                        return { success: false, error };
                    }
                    
                    const files = await response.json();
                    return { success: true, files };
                } catch (error) {
                    console.error('获取文件列表时发生错误:', error);
                    return { success: false, error: error.message };
                }
            },
            
            // 获取文件内容 - 公开仓库不需要认证
            async getFileContent(path, needAuth = false) {
                try {
                    const response = await fetch(
                        `${Config.githubAPI}/repos/${State.githubOwner}/${State.githubRepo}/contents/${path}`,
                        { headers: this.getHeaders(needAuth) }
                    );
                    
                    if (!response.ok) {
                        const error = await response.text();
                        console.error(`获取文件 ${path} 内容失败:`, error);
                        return { success: false, error };
                    }
                    
                    const fileData = await response.json();
                    const content = fileData.content ? Utils.decodeBase64(fileData.content) : '';
                    return { 
                        success: true, 
                        content,
                        sha: fileData.sha
                    };
                } catch (error) {
                    console.error(`获取文件 ${path} 内容时发生错误:`, error);
                    return { success: false, error: error.message };
                }
            },
            
            // 创建或更新文件
            async createOrUpdateFile(path, content, message, sha = null, needAuth = true) {
                try {
                    const payload = {
                        message: message || `Update ${path}`,
                        content: Utils.encodeBase64(content)
                    };
                    
                    // 如果提供了sha，则是更新操作
                    if (sha) {
                        payload.sha = sha;
                    }
                    
                    const response = await fetch(
                        `${Config.githubAPI}/repos/${State.githubOwner}/${State.githubRepo}/contents/${path}`,
                        {
                            method: sha ? 'PUT' : 'PUT',
                            headers: this.getHeaders(needAuth),
                            body: JSON.stringify(payload)
                        }
                    );
                    
                    if (!response.ok) {
                        const error = await response.text();
                        console.error(`创建/更新文件 ${path} 失败:`, error);
                        return { success: false, error };
                    }
                    
                    const result = await response.json();
                    return { success: true, result };
                } catch (error) {
                    console.error(`创建/更新文件 ${path} 时发生错误:`, error);
                    return { success: false, error: error.message };
                }
            },
            
            // 删除文件
            async deleteFile(path, sha, message, needAuth = true) {
                try {
                    const response = await fetch(
                        `${Config.githubAPI}/repos/${State.githubOwner}/${State.githubRepo}/contents/${path}`,
                        {
                            method: 'DELETE',
                            headers: this.getHeaders(needAuth),
                            body: JSON.stringify({
                                message: message || `Delete ${path}`,
                                sha: sha
                            })
                        }
                    );
                    
                    if (!response.ok) {
                        const error = await response.text();
                        console.error(`删除文件 ${path} 失败:`, error);
                        return { success: false, error };
                    }
                    
                    const result = await response.json();
                    return { success: true, result };
                } catch (error) {
                    console.error(`删除文件 ${path} 时发生错误:`, error);
                    return { success: false, error: error.message };
                }
            }
        };

        // 分类管理模块
        const CategoryManager = {
            // 加载分类
            async loadCategories() {
                try {
                    const result = await GitHubAPI.getFileContent(Config.categoriesFile);
                    
                    if (!result.success) {
                        // 如果文件不存在，初始化空分类列表
                        if (result.error.includes('404')) {
                            State.categories = [];
                            return true;
                        }
                        console.error('加载分类失败:', result.error);
                        return false;
                    }
                    
                    try {
                        // 尝试解析分类数据
                        let categories = JSON.parse(result.content);
                        
                        // 确保分类ID是自然整数
                        State.categories = categories.map(cat => ({
                            ...cat,
                            id: Number(cat.id) || Utils.generateCategoryId()
                        }));
                        
                        return true;
                    } catch (parseError) {
                        console.error('解析分类数据失败:', parseError);
                        // 如果解析失败，使用空分类列表
                        State.categories = [];
                        return false;
                    }
                } catch (error) {
                    console.error('加载分类时发生错误:', error);
                    return false;
                }
            },
            
            // 保存分类
            async saveCategories() {
                try {
                    // 先获取现有文件的sha（如果存在）
                    const existingFile = await GitHubAPI.getFileContent(Config.categoriesFile);
                    const sha = existingFile.success ? existingFile.sha : null;
                    
                    // 保存分类数据
                    const result = await GitHubAPI.createOrUpdateFile(
                        Config.categoriesFile,
                        JSON.stringify(State.categories, null, 2),
                        '更新分类列表',
                        sha
                    );
                    
                    if (result.success) {
                        Utils.showStatusMessage('分类保存成功');
                        this.renderCategories();
                        this.renderCategorySelector();
                        return true;
                    } else {
                        Utils.showStatusMessage('分类保存失败: ' + result.error, true);
                        return false;
                    }
                } catch (error) {
                    console.error('保存分类时发生错误:', error);
                    Utils.showStatusMessage('保存分类时发生错误: ' + error.message, true);
                    return false;
                }
            },
            
            // 添加新分类
            async addCategory(name) {
                if (!name || name.trim() === '') {
                    Utils.showStatusMessage('分类名称不能为空', true);
                    return false;
                }
                
                // 检查分类是否已存在
                const exists = State.categories.some(cat => cat.name.trim().toLowerCase() === name.trim().toLowerCase());
                if (exists) {
                    Utils.showStatusMessage('该分类已存在', true);
                    return false;
                }
                
                // 生成自然整数ID
                const newId = Utils.generateCategoryId();
                
                // 添加新分类
                State.categories.push({
                    id: newId,
                    name: name.trim(),
                    createdAt: new Date().toISOString()
                });
                
                // 保存分类
                return await this.saveCategories();
            },
            
            // 更新分类
            async updateCategory(id, newName) {
                if (!newName || newName.trim() === '') {
                    Utils.showStatusMessage('分类名称不能为空', true);
                    return false;
                }
                
                const categoryIndex = State.categories.findIndex(cat => cat.id === id);
                if (categoryIndex === -1) {
                    Utils.showStatusMessage('分类不存在', true);
                    return false;
                }
                
                // 检查新名称是否已被其他分类使用
                const nameExists = State.categories.some(
                    (cat, index) => index !== categoryIndex && 
                    cat.name.trim().toLowerCase() === newName.trim().toLowerCase()
                );
                
                if (nameExists) {
                    Utils.showStatusMessage('该分类名称已存在', true);
                    return false;
                }
                
                // 更新分类名称
                State.categories[categoryIndex].name = newName.trim();
                State.categories[categoryIndex].updatedAt = new Date().toISOString();
                
                // 保存分类
                return await this.saveCategories();
            },
            
            // 删除分类
            async deleteCategory(id) {
                // 检查是否有文章使用该分类
                const articlesWithCategory = State.articles.filter(
                    article => article.categories && article.categories.includes(id)
                );
                
                if (articlesWithCategory.length > 0) {
                    if (!confirm(`该分类下有 ${articlesWithCategory.length} 篇文章，删除分类会同时移除这些文章的分类关联。确定要删除吗？`)) {
                        return false;
                    }
                    
                    // 移除相关文章的分类关联
                    for (const article of articlesWithCategory) {
                        article.categories = article.categories.filter(catId => catId !== id);
                        await ArticleManager.updateArticle(article);
                    }
                }
                
                // 从分类列表中删除
                State.categories = State.categories.filter(cat => cat.id !== id);
                
                // 保存分类
                return await this.saveCategories();
            },
            
            // 渲染分类标签
            renderCategories() {
                const fragment = Utils.createFragment();
                
                // 跳过"全部"标签，它是固定的
                State.categories.forEach(category => {
                    const categoryEl = document.createElement('span');
                    categoryEl.className = `分类标签 ${State.selectedCategory === category.id ? 'active' : ''}`;
                    categoryEl.textContent = category.name;
                    categoryEl.dataset.category = category.id;
                    
                    categoryEl.addEventListener('click', () => {
                        // 更新选中状态
                        document.querySelectorAll('.分类标签').forEach(el => el.classList.remove('active'));
                        categoryEl.classList.add('active');
                        State.selectedCategory = category.id;
                        
                        // 过滤文章
                        ArticleManager.filterArticlesByCategory();
                    });
                    
                    fragment.appendChild(categoryEl);
                });
                
                // 添加到容器（在"全部"标签后面）
                const allTag = Elements.分类容器.querySelector('[data-category="all"]');
                if (allTag) {
                    // 清除现有标签（保留"全部"）
                    Array.from(Elements.分类容器.children).forEach(child => {
                        if (child !== allTag) {
                            Elements.分类容器.removeChild(child);
                        }
                    });
                    Elements.分类容器.appendChild(fragment);
                }
            },
            
            // 渲染分类选择器（用于文章编辑）
            renderCategorySelector() {
                Elements.categorySelector.innerHTML = '';
                const fragment = Utils.createFragment();
                
                State.categories.forEach(category => {
                    const checkboxId = `category-${category.id}`;
                    const label = document.createElement('label');
                    label.className = 'inline-flex items-center';
                    label.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" value="${category.id}" class="form-checkbox h-4 w-4 text-primary rounded">
                        <span class="ml-2">${category.name}</span>
                    `;
                    fragment.appendChild(label);
                });
                
                Elements.categorySelector.appendChild(fragment);
            },
            
            // 渲染分类管理列表
            renderCategoryManagementList() {
                Elements.categoriesList.innerHTML = '';
                const fragment = Utils.createFragment();
                
                if (State.categories.length === 0) {
                    const emptyEl = document.createElement('p');
                    emptyEl.className = 'text-gray-500 italic';
                    emptyEl.textContent = '暂无分类，请添加新分类';
                    Elements.categoriesList.appendChild(emptyEl);
                    return;
                }
                
                State.categories.forEach(category => {
                    const categoryEl = document.createElement('div');
                    categoryEl.className = 'flex justify-between items-center p-3 bg-white border rounded';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = category.name;
                    nameSpan.className = 'flex-1';
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'flex gap-2';
                    
                    const editBtn = document.createElement('button');
                    editBtn.className = 'text-blue-500 hover:text-blue-700';
                    editBtn.innerHTML = '<i class="fa fa-pencil" aria-hidden="true"></i>';
                    editBtn.title = '编辑';
                    editBtn.addEventListener('click', async () => {
                        const newName = prompt('请输入新的分类名称:', category.name);
                        if (newName !== null) {
                            await this.updateCategory(category.id, newName);
                        }
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'text-red-500 hover:text-red-700';
                    deleteBtn.innerHTML = '<i class="fa fa-trash" aria-hidden="true"></i>';
                    deleteBtn.title = '删除';
                    deleteBtn.addEventListener('click', async () => {
                        if (confirm(`确定要删除分类"${category.name}"吗？`)) {
                            await this.deleteCategory(category.id);
                        }
                    });
                    
                    actionsDiv.appendChild(editBtn);
                    actionsDiv.appendChild(deleteBtn);
                    categoryEl.appendChild(nameSpan);
                    categoryEl.appendChild(actionsDiv);
                    fragment.appendChild(categoryEl);
                });
                
                Elements.categoriesList.appendChild(fragment);
            },
            
            // 根据ID获取分类名称
            getCategoryName(id) {
                const category = State.categories.find(cat => cat.id === id);
                return category ? category.name : '未知分类';
            }
        };

        // 文章管理模块
        const ArticleManager = {
            // 加载所有文章
            async loadArticles() {
                try {
                    Elements.文章加载指示器.classList.remove('hidden');
                    Elements.文章列表.classList.add('hidden');
                    
                    // 获取文章目录下的所有文件
                    const result = await GitHubAPI.getFilesList(Config.articlesDir);
                    
                    if (!result.success) {
                        console.error('获取文章列表失败:', result.error);
                        Utils.showStatusMessage('加载文章失败: ' + result.error, true);
                        Elements.文章加载指示器.classList.add('hidden');
                        return false;
                    }
                    
                    // 过滤出Markdown文件
                    const mdFiles = result.files.filter(file => 
                        file.type === 'file' && file.name.endsWith('.md')
                    );
                    
                    // 加载每篇文章内容
                    const articles = [];
                    for (const file of mdFiles) {
                        const contentResult = await GitHubAPI.getFileContent(file.path);
                        if (contentResult.success) {
                            // 解析文章内容
                            const article = this.parseArticleContent(contentResult.content, file.name, file.sha);
                            articles.push(article);
                        }
                    }
                    
                    // 按发布日期排序（最新的在前）
                    State.articles = articles.sort((a, b) => 
                        new Date(b.publishedAt) - new Date(a.publishedAt)
                    );
                    
                    // 渲染文章列表
                    this.renderArticles();
                    
                    Elements.文章加载指示器.classList.add('hidden');
                    Elements.文章列表.classList.remove('hidden');
                    
                    return true;
                } catch (error) {
                    console.error('加载文章时发生错误:', error);
                    Utils.showStatusMessage('加载文章时发生错误: ' + error.message, true);
                    Elements.文章加载指示器.classList.add('hidden');
                    return false;
                }
            },
            
            // 解析文章内容
            parseArticleContent(content, fileName, sha) {
                // 从文件名提取日期（假设格式为 YYYY-MM-DD-标题.md）
                const dateMatch = fileName.match(/^(\d{4}-\d{2}-\d{2})-/);
                const publishedAt = dateMatch ? dateMatch[1] : new Date().toISOString().split('T')[0];
                
                // 解析标题和内容
                const lines = content.split('\n');
                let title = '无标题文章';
                let contentLines = [];
                let categories = [];
                
                // 第一行可能是分类ID（整数）
                if (lines.length > 0 && lines[0].trim() !== '') {
                    try {
                        // 尝试解析第一行为分类ID列表（整数）
                        categories = lines[0].split(',').map(id => parseInt(id.trim(), 10)).filter(id => !isNaN(id));
                        contentLines = lines.slice(1);
                    } catch (e) {
                        // 如果解析失败，将第一行视为内容
                        contentLines = lines;
                    }
                } else {
                    contentLines = lines;
                }
                
                // 尝试从内容中提取标题（第一个#标题）
                for (const line of contentLines) {
                    const headingMatch = line.match(/^#{1,6}\s+(.*)/);
                    if (headingMatch) {
                        title = headingMatch[1];
                        break;
                    }
                }
                
                // 组合内容
                const fullContent = contentLines.join('\n');
                
                return {
                    id: fileName,
                    title,
                    content: fullContent,
                    publishedAt,
                    categories,
                    fileName,
                    sha
                };
            },
            
            // 渲染文章列表
            renderArticles(filteredArticles = null) {
                const articlesToRender = filteredArticles || State.articles;
                const fragment = Utils.createFragment();
                
                if (articlesToRender.length === 0) {
                    const emptyEl = document.createElement('div');
                    emptyEl.className = 'col-span-full text-center py-12';
                    emptyEl.innerHTML = '<p class="text-gray-500 text-lg">暂无文章</p>';
                    fragment.appendChild(emptyEl);
                } else {
                    articlesToRender.forEach(article => {
                        const articleCard = document.createElement('div');
                        articleCard.className = '文章-card bg-white shadow';
                        
                        // 生成预览HTML
                        const previewHtml = marked.parse(article.content.substring(0, 300));
                        const summary = Utils.getArticleSummary(previewHtml);
                        
                        // 生成分类标签HTML
                        const categoryLabels = article.categories
                            .map(catId => CategoryManager.getCategoryName(catId))
                            .map(name => `<span class="分类标签">${name}</span>`)
                            .join('');
                        
                        articleCard.innerHTML = `
                            <div class="p-6">
                                <div class="mb-3">${categoryLabels}</div>
                                <h3 class="text-xl font-bold mb-2 hover:text-primary transition-all-300">${article.title}</h3>
                                <p class="text-gray-600 text-sm mb-4">发布于: ${article.publishedAt}</p>
                                <p class="text-gray-700 mb-4">${summary}</p>
                                <button class="查看文章按钮 bg-primary text-white py-2 px-4 rounded hover:bg-accent transition-all-300">
                                    阅读全文
                                </button>
                            </div>
                        `;
                        
                        // 添加查看文章事件
                        articleCard.querySelector('.查看文章按钮').addEventListener('click', () => {
                            this.showArticleDetail(article);
                        });
                        
                        fragment.appendChild(articleCard);
                    });
                }
                
                Elements.文章列表.innerHTML = '';
                Elements.文章列表.appendChild(fragment);
            },
            
            // 根据分类过滤文章
            filterArticlesByCategory() {
                if (State.selectedCategory === 'all') {
                    this.renderArticles();
                    return;
                }
                
                const filtered = State.articles.filter(article => 
                    article.categories && article.categories.includes(Number(State.selectedCategory))
                );
                this.renderArticles(filtered);
            },
            
            // 显示文章详情
            showArticleDetail(article) {
                // 渲染文章内容
                const categoryLabels = article.categories
                    .map(catId => CategoryManager.getCategoryName(catId))
                    .map(name => `<span class="分类标签">${name}</span>`)
                    .join('');
                
                Elements.文章详情内容.innerHTML = `
                    <div class="p-6">
                        <div class="mb-4">${categoryLabels}</div>
                        <h1 class="text-3xl font-bold mb-6">${article.title}</h1>
                        <p class="text-gray-600 text-sm mb-6">发布于: ${article.publishedAt}</p>
                        <div class="prose max-w-none">${marked.parse(article.content)}</div>
                    </div>
                `;
                
                // 显示模态框
                Elements.文章详情模态框.style.display = 'block';
            },
            
            // 发布新文章
            async publishArticle(title, content, categories) {
                if (!title || title.trim() === '') {
                    Utils.showStatusMessage('文章标题不能为空', true);
                    return false;
                }
                
                if (!content || content.trim() === '') {
                    Utils.showStatusMessage('文章内容不能为空', true);
                    return false;
                }
                
                try {
                    // 生成文件名
                    const fileName = Utils.generateArticleFileName(title);
                    const filePath = `${Config.articlesDir}/${fileName}`;
                    
                    // 构建完整内容（第一行为分类ID列表）
                    const categoriesLine = categories.length > 0 ? categories.join(',') : '';
                    const fullContent = `${categoriesLine}\n${content}`;
                    
                    // 发布文章
                    const result = await GitHubAPI.createOrUpdateFile(
                        filePath,
                        fullContent,
                        `发布新文章: ${title}`
                    );
                    
                    if (result.success) {
                        Utils.showStatusMessage('文章发布成功');
                        
                        // 重新加载文章列表
                        await this.loadArticles();
                        
                        // 清空编辑器
                        Elements.articleTitleInput.value = '';
                        Elements.articleEditor.value = '';
                        Elements.previewContainer.innerHTML = '<p class="text-gray-500 italic">预览将显示在这里...</p>';
                        
                        // 取消分类选择
                        document.querySelectorAll('#category-selector input[type="checkbox"]')
                            .forEach(checkbox => checkbox.checked = false);
                        
                        return true;
                    } else {
                        Utils.showStatusMessage('文章发布失败: ' + result.error, true);
                        return false;
                    }
                } catch (error) {
                    console.error('发布文章时发生错误:', error);
                    Utils.showStatusMessage('发布文章时发生错误: ' + error.message, true);
                    return false;
                }
            },
            
            // 更新文章
            async updateArticle(article) {
                try {
                    const filePath = `${Config.articlesDir}/${article.fileName}`;
                    
                    // 构建完整内容（第一行为分类ID列表）
                    const categoriesLine = article.categories.length > 0 ? article.categories.join(',') : '';
                    const fullContent = `${categoriesLine}\n${article.content}`;
                    
                    // 更新文章
                    const result = await GitHubAPI.createOrUpdateFile(
                        filePath,
                        fullContent,
                        `更新文章: ${article.title}`,
                        article.sha
                    );
                    
                    if (result.success) {
                        // 更新成功后更新sha
                        article.sha = result.result.content.sha;
                        return true;
                    } else {
                        console.error('更新文章失败:', result.error);
                        return false;
                    }
                } catch (error) {
                    console.error('更新文章时发生错误:', error);
                    return false;
                }
            },
            
            // 删除文章
            async deleteArticle(fileName, sha) {
                try {
                    const filePath = `${Config.articlesDir}/${fileName}`;
                    
                    const result = await GitHubAPI.deleteFile(
                        filePath,
                        sha,
                        `删除文章: ${fileName}`
                    );
                    
                    if (result.success) {
                        Utils.showStatusMessage('文章删除成功');
                        // 重新加载文章列表
                        await this.loadArticles();
                        this.renderArticleManagementTable();
                        return true;
                    } else {
                        Utils.showStatusMessage('文章删除失败: ' + result.error, true);
                        return false;
                    }
                } catch (error) {
                    console.error('删除文章时发生错误:', error);
                    Utils.showStatusMessage('删除文章时发生错误: ' + error.message, true);
                    return false;
                }
            },
            
            // 渲染文章管理表格
            renderArticleManagementTable() {
                const tbody = Elements.articlesTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                if (State.articles.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="4" class="py-4 px-4 text-center text-gray-500">暂无文章</td>';
                    tbody.appendChild(row);
                    return;
                }
                
                State.articles.forEach(article => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    
                    // 生成分类标签
                    const categoryNames = article.categories
                        .map(catId => CategoryManager.getCategoryName(catId))
                        .join(', ');
                    
                    row.innerHTML = `
                        <td class="py-3 px-4">${article.title}</td>
                        <td class="py-3 px-4">${article.publishedAt}</td>
                        <td class="py-3 px-4">${categoryNames || '无分类'}</td>
                        <td class="py-3 px-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button class="编辑文章按钮 text-blue-500 hover:text-blue-700" data-file="${article.fileName}">
                                    <i class="fa fa-pencil" aria-hidden="true"></i>
                                </button>
                                <button class="删除文章按钮 text-red-500 hover:text-red-700" data-file="${article.fileName}" data-sha="${article.sha}">
                                    <i class="fa fa-trash" aria-hidden="true"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    // 添加编辑事件
                    row.querySelector('.编辑文章按钮').addEventListener('click', () => {
                        // 切换到编辑文章区域
                        Elements.adminMenuItems.forEach(item => item.classList.remove('active'));
                        Elements.adminSections.forEach(section => section.classList.remove('active'));
                        document.querySelector('[data-section="write-article"]').classList.add('active');
                        document.getElementById('write-article').classList.add('active');
                        
                        // 填充表单
                        Elements.articleTitleInput.value = article.title;
                        Elements.articleEditor.value = article.content;
                        Elements.previewContainer.innerHTML = marked.parse(article.content);
                        
                        // 选中分类
                        document.querySelectorAll('#category-selector input[type="checkbox"]')
                            .forEach(checkbox => {
                                checkbox.checked = article.categories.includes(Number(checkbox.value));
                            });
                    });
                    
                    // 添加删除事件
                    row.querySelector('.删除文章按钮').addEventListener('click', async (e) => {
                        if (confirm('确定要删除这篇文章吗？')) {
                            const fileName = e.currentTarget.dataset.file;
                            const sha = e.currentTarget.dataset.sha;
                            await this.deleteArticle(fileName, sha);
                        }
                    });
                    
                    tbody.appendChild(row);
                });
            }
        };

        // 日历模块
        const Calendar = {
            // 初始化日历
            init() {
                this.renderCalendar(State.currentDate);
                this.updateCurrentTime();
                setInterval(() => this.updateCurrentTime(), 60000); // 每分钟更新一次时间
            },
            
            // 更新当前时间显示
            updateCurrentTime() {
                const now = new Date();
                Elements.当前时间显示.textContent = now.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },
            
            // 渲染日历
            renderCalendar(date) {
                const year = date.getFullYear();
                const month = date.getMonth();
                
                // 更新标题显示
                Elements.当前年月显示.textContent = `${year}年 ${month + 1}月`;
                
                // 获取当月第一天是星期几
                const firstDay = new Date(year, month, 1).getDay();
                
                // 获取当月的天数
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                // 获取上个月的最后几天
                const prevMonthDays = firstDay;
                const prevMonth = month === 0 ? 11 : month - 1;
                const prevMonthYear = month === 0 ? year - 1 : year;
                const daysInPrevMonth = new Date(prevMonthYear, prevMonth + 1, 0).getDate();
                
                // 计算需要显示的下个月的天数
                const totalDaysToShow = prevMonthDays + daysInMonth;
                const nextMonthDays = totalDaysToShow % 7 === 0 ? 0 : 7 - (totalDaysToShow % 7);
                
                // 清空日历网格
                Elements.日历网格.innerHTML = '';
                
                // 添加星期标题
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                weekdays.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'font-bold p-2';
                    dayEl.textContent = day;
                    Elements.日历网格.appendChild(dayEl);
                });
                
                // 添加上个月的日期
                for (let i = 0; i < prevMonthDays; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'p-2 text-gray-400';
                    dayEl.textContent = daysInPrevMonth - prevMonthDays + i + 1;
                    Elements.日历网格.appendChild(dayEl);
                }
                
                // 添加当前月的日期
                const today = new Date();
                const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
                
                for (let i = 1; i <= daysInMonth; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'p-2 border rounded cursor-pointer hover:bg-gray-100 transition-all-300';
                    
                    // 标记今天
                    if (isCurrentMonth && today.getDate() === i) {
                        dayEl.classList.add('今日日期标记', 'font-bold');
                    }
                    
                    dayEl.textContent = i;
                    
                    // 检查该日期是否有文章
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const hasArticles = State.articles.some(article => article.publishedAt === dateStr);
                    
                    if (hasArticles) {
                        dayEl.classList.add('bg-secondary/20');
                        dayEl.addEventListener('click', () => {
                            this.showArticlesForDate(dateStr);
                        });
                    }
                    
                    Elements.日历网格.appendChild(dayEl);
                }
                
                // 添加下个月的日期
                for (let i = 1; i <= nextMonthDays; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'p-2 text-gray-400';
                    dayEl.textContent = i;
                    Elements.日历网格.appendChild(dayEl);
                }
                
                // 显示随机哲言
                this.showRandomPhilosophicalQuote();
            },
            
            // 显示指定日期的文章
            showArticlesForDate(dateStr) {
                const articlesOnDate = State.articles.filter(article => article.publishedAt === dateStr);
                
                if (articlesOnDate.length === 0) {
                    Utils.showStatusMessage(`该日期(${dateStr})没有文章`, true);
                    return;
                }
                
                // 关闭日历模态框
                Elements.日历模态框.style.display = 'none';
                
                // 过滤并显示文章
                State.selectedCategory = 'all';
                document.querySelectorAll('.分类标签').forEach(el => el.classList.remove('active'));
                document.querySelector('[data-category="all"]').classList.add('active');
                
                ArticleManager.renderArticles(articlesOnDate);
            },
            
            // 显示随机哲言
            showRandomPhilosophicalQuote() {
                const randomIndex = Math.floor(Math.random() * State.philosophicalQuotes.length);
                const quote = State.philosophicalQuotes[randomIndex];
                Elements.哲言区域.innerHTML = `"${quote.quote}" —— ${quote.author}`;
            },
            
            // 切换到上一个月
            prevMonth() {
                State.currentDate.setMonth(State.currentDate.getMonth() - 1);
                this.renderCalendar(State.currentDate);
            },
            
            // 切换到下一个月
            nextMonth() {
                State.currentDate.setMonth(State.currentDate.getMonth() + 1);
                this.renderCalendar(State.currentDate);
            }
        };

        // 管理后台模块
        const AdminPanel = {
            // 初始化管理后台
            async init() {
                // 显示加载状态
                Elements.adminLoading.classList.remove('hidden');
                Elements.adminContentContainer.classList.add('hidden');
                
                try {
                    // 加载分类和文章数据
                    await Promise.all([
                        CategoryManager.loadCategories(),
                        ArticleManager.loadArticles()
                    ]);
                    
                    // 渲染管理界面
                    CategoryManager.renderCategorySelector();
                    CategoryManager.renderCategoryManagementList();
                    ArticleManager.renderArticleManagementTable();
                    
                    // 更新当前仓库信息
                    Elements.currentRepoInfo.textContent = `${State.githubOwner}/${State.githubRepo}`;
                    
                    // 隐藏加载状态，显示内容
                    Elements.adminLoading.classList.add('hidden');
                    Elements.adminContentContainer.classList.remove('hidden');
                    
                    return true;
                } catch (error) {
                    console.error('初始化管理后台失败:', error);
                    Utils.showStatusMessage('加载管理界面失败: ' + error.message, true);
                    return false;
                }
            },
            
            // 切换管理菜单
            switchMenu(sectionId) {
                // 更新菜单选中状态
                Elements.adminMenuItems.forEach(item => {
                    item.classList.toggle('active', item.dataset.section === sectionId);
                });
                
                // 更新内容显示
                Elements.adminSections.forEach(section => {
                    section.classList.toggle('active', section.id === sectionId);
                });
            },
            
            // 退出登录
            logout() {
                if (confirm('确定要退出登录吗？')) {
                    localStorage.removeItem('githubToken');
                    State.githubToken = null;
                    State.isAuthenticated = false;
                    
                    // 关闭管理模态框
                    Elements.后台管理模态框.style.display = 'none';
                    
                    Utils.showStatusMessage('已退出登录');
                }
            }
        };

        // 编辑器模块
        const Editor = {
            // 初始化编辑器
            init() {
                // 为编辑器按钮添加事件
                Elements.editorButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const command = button.dataset.command;
                        this.executeCommand(command);
                    });
                });
                
                // 实时预览
                Elements.articleEditor.addEventListener('input', () => {
                    this.updatePreview();
                });
            },
            
            // 执行编辑命令
            executeCommand(command) {
                const editor = Elements.articleEditor;
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const selectedText = editor.value.substring(start, end);
                
                let resultText = '';
                let cursorOffset = 0;
                
                switch (command) {
                    case 'bold':
                        resultText = `**${selectedText || '粗体文本'}**`;
                        cursorOffset = selectedText ? 0 : 6; // 如果没有选中文本，光标放在中间
                        break;
                    case 'italic':
                        resultText = `*${selectedText || '斜体文本'}*`;
                        cursorOffset = selectedText ? 0 : 4;
                        break;
                    case 'heading':
                        resultText = `# ${selectedText || '标题'}`;
                        cursorOffset = selectedText ? 0 : 3;
                        break;
                    case 'list':
                        resultText = `- ${selectedText || '列表项'}`;
                        cursorOffset = selectedText ? 0 : 3;
                        break;
                    case 'link':
                        resultText = `[${selectedText || '链接文本'}](https://example.com)`;
                        cursorOffset = selectedText ? 0 : selectedText ? 0 : 13;
                        break;
                    case 'image':
                        resultText = `![${selectedText || '图片描述'}](https://example.com/image.jpg)`;
                        cursorOffset = selectedText ? 0 : 20;
                        break;
                    case 'code':
                        resultText = `\`\`\`\n${selectedText || '代码'}\n\`\`\``;
                        cursorOffset = selectedText ? 0 : 4;
                        break;
                }
                
                // 替换选中内容
                editor.value = 
                    editor.value.substring(0, start) + 
                    resultText + 
                    editor.value.substring(end);
                
                // 设置光标位置
                const newCursorPos = start + (selectedText ? resultText.length : cursorOffset);
                editor.focus();
                editor.setSelectionRange(newCursorPos, newCursorPos);
                
                // 更新预览
                this.updatePreview();
            },
            
            // 更新预览
            updatePreview() {
                const content = Elements.articleEditor.value;
                Elements.previewContainer.innerHTML = content ? marked.parse(content) : 
                    '<p class="text-gray-500 italic">预览将显示在这里...</p>';
            }
        };

        // 初始化应用
        async function initApp() {
            // 加载分类和文章
            await Promise.all([
                CategoryManager.loadCategories(),
                ArticleManager.loadArticles()
            ]);
            
            // 渲染分类
            CategoryManager.renderCategories();
            
            // 初始化日历
            Calendar.init();
            
            // 初始化编辑器
            Editor.init();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 设置自动同步
            setInterval(async () => {
                if (new Date() - (State.lastSyncTime || 0) > Config.syncInterval) {
                    console.log('自动同步数据...');
                    State.lastSyncTime = new Date();
                    await Promise.all([
                        CategoryManager.loadCategories(),
                        ArticleManager.loadArticles()
                    ]);
                    CategoryManager.renderCategories();
                }
            }, Config.syncInterval);
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 关闭模态框按钮
            Elements.closeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const modal = button.closest('.modal');
                    if (modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // 点击模态框外部关闭
            Elements.modals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
            
            // 日历按钮
            Elements.日历按钮.addEventListener('click', () => {
                Elements.日历模态框.style.display = 'block';
            });
            
            // 日历月份切换
            Elements.上一月按钮.addEventListener('click', () => Calendar.prevMonth());
            Elements.下一月按钮.addEventListener('click', () => Calendar.nextMonth());
            
            // 尘幕工作室按钮（管理后台）
            Elements.尘幕工作室按钮.addEventListener('click', async () => {
                if (State.isAuthenticated) {
                    // 已登录，直接显示管理后台
                    Elements.后台管理模态框.style.display = 'block';
                    await AdminPanel.init();
                } else {
                    // 未登录，显示验证模态框
                    Elements.github验证模态框.style.display = 'block';
                }
            });
            
            // GitHub验证按钮
            Elements.验证按钮.addEventListener('click', async () => {
                const token = Elements.githubTokenInput.value.trim();
                
                if (!token) {
                    Utils.showErrorLog(Elements.验证错误日志, '请输入GitHub令牌');
                    return;
                }
                
                // 显示验证状态
                Elements.验证状态.textContent = '正在验证...';
                Elements.验证状态.className = 'mt-3 text-center';
                Elements.验证状态.classList.remove('hidden', 'text-green-500', 'text-red-500');
                
                try {
                    // 临时保存令牌用于验证
                    State.githubToken = token;
                    
                    // 测试令牌有效性
                    const isValid = await GitHubAPI.testToken();
                    
                    if (isValid) {
                        // 验证成功
                        Elements.验证状态.textContent = '验证成功！正在进入管理后台...';
                        Elements.验证状态.classList.add('text-green-500');
                        
                        // 保存令牌
                        localStorage.setItem('githubToken', token);
                        State.isAuthenticated = true;
                        
                        // 关闭验证模态框
                        setTimeout(() => {
                            Elements.github验证模态框.style.display = 'none';
                            Elements.githubTokenInput.value = '';
                            Elements.验证状态.classList.add('hidden');
                            
                            // 显示管理后台
                            Elements.后台管理模态框.style.display = 'block';
                            AdminPanel.init();
                        }, 1000);
                    } else {
                        // 验证失败
                        Elements.验证状态.textContent = '验证失败，请检查令牌是否正确';
                        Elements.验证状态.classList.add('text-red-500');
                        State.githubToken = null;
                    }
                } catch (error) {
                    console.error('验证令牌时发生错误:', error);
                    Elements.验证状态.textContent = '验证时发生错误: ' + error.message;
                    Elements.验证状态.classList.add('text-red-500');
                    State.githubToken = null;
                }
            });
            
            // 管理菜单切换
            Elements.adminMenuItems.forEach(item => {
                if (item.dataset.section) {
                    item.addEventListener('click', () => {
                        AdminPanel.switchMenu(item.dataset.section);
                    });
                }
            });
            
            // 发布文章按钮
            Elements.发布文章按钮.addEventListener('click', () => {
                const title = Elements.articleTitleInput.value.trim();
                const content = Elements.articleEditor.value.trim();
                
                // 获取选中的分类
                const selectedCategories = Array.from(
                    document.querySelectorAll('#category-selector input[type="checkbox"]:checked')
                ).map(checkbox => parseInt(checkbox.value, 10));
                
                ArticleManager.publishArticle(title, content, selectedCategories);
            });
            
            // 添加分类按钮
            Elements.addCategoryBtn.addEventListener('click', () => {
                const categoryName = Elements.newCategoryName.value.trim();
                CategoryManager.addCategory(categoryName);
                Elements.newCategoryName.value = '';
            });
            
            // 退出登录按钮
            Elements.退出登录按钮.addEventListener('click', () => {
                AdminPanel.logout();
            });
            
            // 切换仓库按钮
            Elements.切换仓库按钮.addEventListener('click', async () => {
                Elements.后台管理模态框.style.display = 'none';
                await showRepoSelectModal();
            });
            
            // 仓库选择确认按钮
            Elements.confirmRepoBtn.addEventListener('click', () => {
                if (State.selectedRepo) {
                    Utils.saveRepoInfo(State.selectedRepo.owner.login, State.selectedRepo.name);
                    Elements.currentRepoInfo.textContent = `${State.githubOwner}/${State.githubRepo}`;
                    Elements.repoSelectModal.style.display = 'none';
                    
                    // 重新加载管理界面
                    Elements.后台管理模态框.style.display = 'block';
                    AdminPanel.init();
                    
                    Utils.showStatusMessage(`已切换到仓库: ${State.githubOwner}/${State.githubRepo}`);
                }
            });
        }

        // 显示仓库选择模态框
        async function showRepoSelectModal() {
            Elements.repoSelectModal.style.display = 'block';
            Elements.repoLoading.classList.remove('hidden');
            Elements.repoListContainer.classList.add('hidden');
            Elements.repoList.innerHTML = '';
            Elements.confirmRepoBtn.disabled = true;
            
            try {
                const result = await GitHubAPI.getUserRepos();
                
                if (result.success) {
                    // 按名称排序，包含"philosophy"或"blog"的仓库排在前面
                    const sortedRepos = result.repos.sort((a, b) => {
                        const aIsBlog = /philosophy|blog/i.test(a.name);
                        const bIsBlog = /philosophy|blog/i.test(b.name);
                        
                        if (aIsBlog && !bIsBlog) return -1;
                        if (!aIsBlog && bIsBlog) return 1;
                        return a.name.localeCompare(b.name);
                    });
                    
                    // 渲染仓库列表
                    sortedRepos.forEach(repo => {
                        const repoEl = document.createElement('div');
                        repoEl.className = `repo-item ${repo.full_name === `${State.githubOwner}/${State.githubRepo}` ? 'selected' : ''}`;
                        repoEl.innerHTML = `
                            <div class="font-bold">${repo.name}</div>
                            <div class="text-sm text-gray-600">${repo.description || '无描述'}</div>
                        `;
                        
                        repoEl.addEventListener('click', () => {
                            // 移除其他选中状态
                            document.querySelectorAll('.repo-item').forEach(el => 
                                el.classList.remove('selected')
                            );
                            
                            // 设置当前选中
                            repoEl.classList.add('selected');
                            State.selectedRepo = repo;
                            Elements.confirmRepoBtn.disabled = false;
                        });
                        
                        Elements.repoList.appendChild(repoEl);
                    });
                    
                    Elements.repoLoading.classList.add('hidden');
                    Elements.repoListContainer.classList.remove('hidden');
                } else {
                    Utils.showErrorLog(Elements.repoSelectError, result.error);
                    Elements.repoLoading.classList.add('hidden');
                    Elements.repoListContainer.classList.remove('hidden');
                }
            } catch (error) {
                console.error('加载仓库列表失败:', error);
                Utils.showErrorLog(Elements.repoSelectError, error.message);
                Elements.repoLoading.classList.add('hidden');
                Elements.repoListContainer.classList.remove('hidden');
            }
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
